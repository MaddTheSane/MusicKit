#!/bin/zsh
# $Id$
#
# zsh script to automate the packaging of MusicKit and SndKit source trees from
# the CVS repository ready for download.
#
# Leigh Smith <leigh@tomandandy.com> 2000/1/3
#

# Default distribution is the MusicKit.
DISTNAME=MusicKit
DISTCHECKEDOUTSRCLOC=/tmp/MKSRC
# This allows us to have a different default CVSROOT
MKCVSROOT=:ext:leighsmith@cvs.musickit.sourceforge.net:/cvsroot/musickit
PACKAGENAME=MK
if [ x_$1 = x_ ]; then
    echo "${DISTNAME} source shipping script"
    echo "Usage: $0 distribution version_number previous_version"
    echo "Where version_number is of the form V.R.P and matches the CVS tag ${DISTNAME}_V-R-P"
    exit 1;
else
    DISTNAME=$1
    RELEASE=$2
    PREVRELEASE=$3
fi
# Salt to taste:
TAR=gnutar
CHGLOGGEN=cvs2cl.pl
TARLOC=/tmp
CVSTAG=${DISTNAME}_`echo $RELEASE | tr '.' '-'`

# determine the date of the last tagged release.
# PREVCVSTAG=${DISTNAME}_5-3-1 
PREVCVSTAG=${DISTNAME}_`echo $PREVRELEASE | tr '.' '-'`

# Checkout the source tree
echo Checking out $CVSTAG to $DISTCHECKEDOUTSRCLOC
mkdir -p $DISTCHECKEDOUTSRCLOC
cd $DISTCHECKEDOUTSRCLOC
cvs -d $MKCVSROOT -Q checkout -r $CVSTAG $DISTNAME

# unwrap the symbolic links, this will remove the symbolic links wrap file.
unwrap_symlink $DISTNAME

# build a ChangeLog with spaces between filenames and comments, 
# collected to half-day window, incorporating tags.
cd $DISTCHECKEDOUTSRCLOC/$DISTNAME
$CHGLOGGEN --no-wrap --separate-header --window 43200 --file Documentation/ChangeLog
# copy it so it can be used for generating an announcement.
cp Documentation/ChangeLog $TARLOC/${DISTNAME}_ChangeLog

echo Logging changes after $PREVCVSTAG to $CVSTAG
# This is the means to generate what we've done since last release.
# '-d\>2000-10-09'
$CHGLOGGEN --no-wrap --separate-header --window 43200 --file $TARLOC/${DISTNAME}_ChangeLog_${RELEASE} --log-opts "-r${PREVCVSTAG}:${CVSTAG}"

# create a readily readable PDF version of the README.sgml file
# packageREADME
# Unfortunately, the SGML tools don't work on MacOS X, so we suffice by copying them...
cp /tmp/${DISTNAME}_README.pdf $DISTCHECKEDOUTSRCLOC/$DISTNAME

# remove CVS directories (they will be different for each user if checking out direct from the repository).
find $DISTCHECKEDOUTSRCLOC -name CVS -type d -exec rm -r {} \; -prune

# tar up the remaining source
cd $DISTCHECKEDOUTSRCLOC
# rename the directory to the current version.
mv $DISTNAME ${DISTNAME}-$RELEASE
PACKAGEFILE=$TARLOC/${PACKAGENAME}-${RELEASE}.s.tar.gz
$TAR czf $PACKAGEFILE ${DISTNAME}-${RELEASE}

echo Archive generated at $PACKAGEFILE
echo ChangeLog generated at $TARLOC/${DISTNAME}_ChangeLog
echo ChangeLog since $PREVCVSTAG generated at $TARLOC/${DISTNAME}_ChangeLog_${RELEASE}

# blow away the checked out source.
rm -r $DISTCHECKEDOUTSRCLOC

# The user needs to use shipSource to upload to upload.sourceforge.net/incoming
# using ftp.
