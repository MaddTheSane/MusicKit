#!/bin/sh
# $Id$
# Create a set of HTML pages from the SGML documentation suitable for
# distribution on the web-site. We do this with a customised stylesheet (in DSSSL)
# to produce the correct text coloring, background images etc.
#
# Also creates HTML pages of class documentation from header files
# using HeaderDoc and copies in PDF's of documentation.
# The entire tree of documentation is then packaged up suitable for
# shipping to a webserver.
#
# Leigh Smith <leigh@tomandandy.com>
#

JADE=openjade

# HTML_DISTRIB_DIR makes it easier to install into SourceForge.
HTML_DISTRIB_DIR=htdocs
HTML_TMPDIR=/tmp/$HTML_DISTRIB_DIR
HTML_TARBALL=/tmp/MusicKitREADME.tar.gz

PDF_TMPDIR=/tmp/mkpdf

# Assume we are standing at the top of the source tree, since with NFS
# it's a bit hard to be universal with paths.
MKSRCDIR=`pwd`
# Assume SndKit will sit next to MusicKit in the directory 
SKSRCDIR=$MKSRCDIR/../SndKit
MKDOCDIR=$MKSRCDIR/Documentation
MKREADMESRC=$MKDOCDIR/MusicKit_README.sgml
MKCONCEPTS=$MKDOCDIR/Concepts/
MKTUTORIALS=$MKDOCDIR/TutorialClasses/
MKPUBLICATIONS=$MKDOCDIR/Publications/
MKHEADERDOC=$MKDOCDIR/HeaderDoc/
MK_STYLEDIR=$MKDOCDIR/SGML
MK_STYLESHEET=$MK_STYLEDIR/MusicKit_README.dsssl
#MKCONCEPTS_STYLESHEET=/sw/share/sgml/dsssl/docbook-dsssl-nwalsh/html/docbook.dsl
MKCONCEPTS_STYLESHEET=$MK_STYLESHEET
MKTUTORIALS_STYLESHEET=$MKCONCEPTS_STYLESHEET

# We allow the path to the ChangeLog to be passed in so it can be
# posted onto the web for inspection.
CHANGELOG=$1

#
# Convert all SGML to HTML and package
#
rm -rf $HTML_TMPDIR
mkdir $HTML_TMPDIR
cd $HTML_TMPDIR
$JADE -t sgml -ihtml -d ${MK_STYLESHEET}\#html $MKREADMESRC
ln -s readme.html index.html
cp $MK_STYLEDIR/Images/*.{gif,jpg,png} .

#
# Generate the Concepts Book underneath the README directory, so it
# can be referenced by URL independent of the README directory.
#
mkdir -p $HTML_TMPDIR/MusicKitConcepts/Images
cd $HTML_TMPDIR/MusicKitConcepts
$JADE -t sgml -ihtml -d ${MKCONCEPTS_STYLESHEET}\#html $MKCONCEPTS/MusicKitConcepts.sgml
cp -r $MKCONCEPTS/Images/*.gif Images
ln -s musickitconcepts.html index.html

#
# Generate the tutorials and also place them under the README directory.
#
mkdir -p $HTML_TMPDIR/TutorialClasses/Images
cd $HTML_TMPDIR/TutorialClasses
$JADE -t sgml -ihtml -d ${MKTUTORIALS_STYLESHEET}\#html $MKTUTORIALS/MusicKitTutorials.sgml
cp -r $MKTUTORIALS/Images/*.gif Images
ln -s musickittutorials.html index.html

#
# Run HeaderDoc over the frameworks
#
mkdir $HTML_TMPDIR/Frameworks
cat > $HTML_TMPDIR/Frameworks/index.html <<EOF
<HTML>
<!-- This file has been automatically generated by packageDocumentation, do not edit  -->
<HEAD><TITLE>MusicKit and SndKit Documented Frameworks</TITLE></HEAD>
<BODY bgcolor="#442643" text="#FFFFFF" link="#C7DE1E" alink="#969FF4" vlink="#80C2E2"> 
<center><H1>MusicKit and SndKit Documented Frameworks</H1></center>
EOF

cd $MKHEADERDOC
# The MacOS X version of the MKPerformSndMIDI framework is the 
# definitive documentation version.
FRAMEWORKS_TO_HEADERDOC="$MKSRCDIR/Frameworks/MusicKit $SKSRCDIR/Frameworks/SndKit $MKSRCDIR/Frameworks/MKSynthPatches $MKSRCDIR/Frameworks/MKUnitGenerators $MKSRCDIR/Frameworks/PlatformDependent/MKPerformSndMIDI_MacOSX"

for frameworkDir in $FRAMEWORKS_TO_HEADERDOC; do (
    # We get a bit sneaky here and assume any part of the framework name
    # following an underscore is not what we want to have appear in
    # the output.
    CLEANED_FRAMEWORK=`basename $frameworkDir`
    FRAMEWORK_DOC_OUT_DIR=$HTML_TMPDIR/Frameworks/$CLEANED_FRAMEWORK
    headerdoc2html -o $FRAMEWORK_DOC_OUT_DIR $frameworkDir
    gatherheaderdoc -p "$CLEANED_FRAMEWORK" $FRAMEWORK_DOC_OUT_DIR
    echo "<a href=$CLEANED_FRAMEWORK>$CLEANED_FRAMEWORK</a><p>" >> $HTML_TMPDIR/Frameworks/index.html
    cd $FRAMEWORK_DOC_OUT_DIR
    # Gatherheaderdoc generates a file MasterTOC.html, that we make the
    # default file. 
    ln -s MasterTOC.html index.html
); 
done

cat >> $HTML_TMPDIR/Frameworks/index.html <<EOF
<p>
<a href=..>Back to main documentation page</a>
</body>
</html>
EOF

# Copy images to appear in the class documentation into each respective class.
mkdir $HTML_TMPDIR/Frameworks/MKSynthPatches/Images
cp $MKSRCDIR/Documentation/Frameworks/SynthPatches/Reference/Classes/Images/*.png $HTML_TMPDIR/Frameworks/MKSynthPatches/Images

# if we specified a changelog on the command line, copy it into the
# web directory.
if [ ${CHANGELOG}_x != _x ]; then
    cp $CHANGELOG $HTML_TMPDIR
fi

#
# Now create the PDF of the README
#
MKREADMETEX=`basename $MKREADMESRC .sgml`.tex
PDFFINAL=`basename $MKREADMESRC .sgml`.pdf
rm -rf $PDF_TMPDIR
mkdir $PDF_TMPDIR
cd $PDF_TMPDIR 
cp $MK_STYLEDIR/Images/*.eps .
$JADE -t tex -d ${MK_STYLESHEET}\#print -o $MKREADMETEX $MKREADMESRC
jadetex $MKREADMETEX 
dvips -o prepared.ps MusicKit_README.dvi
ps2pdf prepared.ps /tmp/$PDFFINAL
echo MusicKit README PDF file generated into /tmp/$PDFFINAL

#
# Create PDF of the concepts documentation
# This should become a subroutine.
#  cd $PDF_TMPDIR 
#  cp $MK_STYLEDIR/Images/*.eps .
#  db2dvi $MKCONCEPTS/MusicKitConcepts.sgml # 2>1 /tmp/db.log
#  PDFFINAL=`basename $MKREADMESRC .sgml`.pdf
#  dvips -o intermediate.ps MusicKitConcepts.dvi
#  # This allows us to incorporate any special postscript fonts.
#  #psprepare intermediate.ps prepared.ps
#  cp intermediate.ps prepared.ps
#  ps2pdf prepared.ps /tmp/$PDFFINAL
#  echo MusicKit README PDF file generated into /tmp/$PDFFINAL
#  mkdir -p $HTML_TMPDIR/MusicKitConcepts/Images
#  cd $HTML_TMPDIR/MusicKitConcepts
#  $JADE -t sgml -ihtml -d ${MKCONCEPTS_STYLESHEET}\#html 
#  cp -r $MKCONCEPTS/Images/*.gif Images
#  ln -s musickitconcepts.html index.html

rm -r $PDF_TMPDIR

#
# copy all PDFs to be placed on the web-site, both those prepared and the README
#
mkdir -p $HTML_TMPDIR/Publications
cp $MKPUBLICATIONS/*.pdf $HTML_TMPDIR/Publications
cp /tmp/$PDFFINAL $HTML_TMPDIR

#
# Now create a tarball
#
cd /tmp
tar czf $HTML_TARBALL $HTML_DISTRIB_DIR
echo MusicKit README HTML pages packaged into $HTML_TARBALL
rm -r $HTML_TMPDIR
